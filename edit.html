<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="A front-end template that helps you build fast, modern mobile web apps.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <title>Carolina Bazaar</title>

  <link rel="shortcut icon" href="images/favicon.png">

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-pink.min.css" />
  <link rel="stylesheet" href="styles.css">
  <style>
    #view-source {
      position: fixed;
      display: block;
      right: 0;
      bottom: 0;
      margin-right: 40px;
      margin-bottom: 40px;
      z-index: 900;
    }
  </style>
</head>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-storage.js"></script>


<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyD9iTV9_CQQgCihDgukIro8KlAjsrAkjE0",
    authDomain: "carolinabazaar.firebaseapp.com",
    databaseURL: "https://carolinabazaar.firebaseio.com",
    projectId: "carolinabazaar",
    storageBucket: "carolinabazaar.appspot.com",
    messagingSenderId: "158634412956",
    appId: "1:158634412956:web:8049a221c38600f9aa5659",
    measurementId: "G-R5CD2TQLHH"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
</script>


<body class="mdl-demo mdl-color--grey-100 mdl-color-text--grey-700 mdl-base">
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header
      mdl-layout--fixed-tabs">
    <header class="mdl-layout__header">

      <div class="mdl-layout--large-screen-only mdl-layout__header-row" style="margin-top: 30px; margin-bottom: 30px;">
        <h3>Carolina Bazaar</h3>
      </div>


      <div class="mdl-layout__tab-bar mdl-js-ripple-effect mdl-color--primary-dark">
        <a href="index.html" class="mdl-layout__tab">Listings</a>
        <a href="makelisting.html" class="mdl-layout__tab is-active">In Progress</a>
        <button
          class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored mdl-shadow--4dp mdl-color--accent"
          id="add" style="background: rgb(255,64,129);">
          <i class="material-icons" role="presentation">logout</i>
          <span class="visuallyhidden">Add</span>
        </button>
      </div>
    </header>
    <main class="mdl-layout__content">
      <div class="mdl-layout__tab-panel is-active" id="overview">


        <style>
          .demo-card-square.mdl-card {
            width: 320px;
            height: 320px;
          }

          .demo-card-square>.mdl-card__title {
            color: #fff;
            background:
              url('../assets/demos/dog.png') bottom right 15% no-repeat #46B6AC;
          }
        </style>




        <div class="mdl-grid" style="justify-content: center">



          <div class="mdl-card mdl-cell mdl-cell--4-col mdl-shadow--2dp mdl-cell--top" id="side_image">

            <center>
              <div class="mdl-spinner mdl-js-spinner is-active" id="loading_photo" style="margin-top: 50px;"></div>
            </center>

            <img src="" id="image" width="100%">
          </div>


          <div class="mdl-card mdl-cell mdl-cell--6-col">
            <center>
              <div class="mdl-spinner mdl-js-spinner is-active" id="loading_text" style="margin-top: 50px;"></div>
            </center>

            <div class="mdl-card__supporting-text mdl-grid mdl-grid--no-spacing" id="content" style="display: none;">
              <h4 class="mdl-cell mdl-cell--12-col">Edit Listing</h4>

              <table>
                <tr>
                  <td>
                    <b>Item Title</b>
                    <br>
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                      <input class="mdl-textfield__input" type="text" id="title">
                      <label class="mdl-textfield__label" for="sample3"></label>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <b>Description</b>
                    <br>
                    <div class="mdl-textfield mdl-js-textfield">
                      <textarea class="mdl-textfield__input" type="text" rows="3" id="description"></textarea>
                      <label class="mdl-textfield__label" for="sample5"></label>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td>
                    <b>Category</b>
                    <br>
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                      <select class="mdl-textfield__input" id="category" name="octane">
                        <option></option>
                        <option value="Textbooks">Textbooks</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Miscellaneous">Miscellaneous</option>
                      </select>
                      <label class="mdl-textfield__label" for="octane"></label>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>
                    <b>$ Price</b>
                    <br>
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                      <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?" id="price">
                      <label class="mdl-textfield__label" for="sample4"></label>
                      <span class="mdl-textfield__error">Input is not a price!</span>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td><button
                      class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored"
                      onclick="uploadImage()">
                      Upload Picture
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div id="progress" class="mdl-progress mdl-js-progress mdl-progress__indeterminate" hidden></div>
                  </td>
                </tr>
                <tr>
                  <td> <br><button
                      class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent"
                      onclick="submitListing()">
                      Submit
                    </button></td>
                </tr>
              </table>

              <br>
              <input id="uploadimage" type="file" name="pic" accept="image/*" hidden></input>

            </div>
          </div>

        </div>



        <br>
        <br>
      </div>

    </main>




  </div>



  <script>

    var file = null;

    function uploadImage() {
      var uploadButton = document.getElementById("uploadimage");

      document.getElementById("side_image").style.display = "none";

      uploadButton.addEventListener("change", function (e) {
        console.log(e);

        file = e.target.files[0];

      });
      document.getElementById('uploadimage').click();
    }

    firebase.auth().onAuthStateChanged(function (user) {
      if (user) {
        // User is signed in.
      } else {
        var provider = new firebase.auth.GoogleAuthProvider();

        firebase.auth().signInWithRedirect(provider);

      }
    });
    function submitListing() {
      document.getElementById("progress").style.display = "block";

      var title = document.getElementById("title").value;
      var description = document.getElementById("description").value;
      var category = document.getElementById("category").value;
      var price = document.getElementById("price").value;

      var uid = firebase.auth().currentUser.uid;

      var db = firebase.firestore();

      //var listing = db.collection("users/" + uid + "/listings").doc();
      //const listingKey = listing.id;

      var urlParams = new URLSearchParams(window.location.search);
      var listingKey = urlParams.get('id');


      if (file != null) {
        var storageRef = firebase.storage().ref(uid + "/" + listingKey + ".jpg");
        var task = storageRef.put(file);
        task.on("state_changed",
          function (snapshot) {
            var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          },
          function (error) {

          },

          function () {
            task.snapshot.ref.getDownloadURL().then(function (url) {
              db.collection("users/" + uid + "/listings").doc(listingKey).update({
                title: title,
                description: description,
                price: price,
                category: category,
                image: url,
                time: firebase.firestore.FieldValue.serverTimestamp(),
                seller: uid

              }).then(function () {
                db.collection("listings").doc(listingKey).update({
                  title: title,
                  description: description,
                  price: price,
                  category: category,
                  image: url,
                  time: firebase.firestore.FieldValue.serverTimestamp(),
                  seller: uid
                }).then(function () {
                  window.location = "inprogress.html";
                });
              });


            });
          }
        );
      }
      else {
        db.collection("users/" + uid + "/listings").doc(listingKey).update({
          title: title,
          description: description,
          price: price,
          category: category,
          time: firebase.firestore.FieldValue.serverTimestamp(),
          seller: uid

        }).then(function () {
          db.collection("listings").doc(listingKey).update({
            title: title,
            description: description,
            price: price,
            category: category,
            time: firebase.firestore.FieldValue.serverTimestamp(),
            seller: uid
          }).then(function () {
            window.location = "inprogress.html";
          });

        });


      }
    }

  </script>



  <script>

    var urlParams = new URLSearchParams(window.location.search);
    var id = urlParams.get('id');

    var db = firebase.firestore();

    var docRef = db.collection("listings").doc(id);

    docRef.get().then(function (doc) {
      if (doc.exists) {


        document.getElementById("loading_text").style.display = "none";
        document.getElementById("loading_photo").style.display = "none";

        document.getElementById("content").style.display = "block";

        var data = doc.data();



        document.getElementById("title").value = data.title;
        document.getElementById("title").parentElement.classList.add("is-upgraded");

        document.getElementById("description").value = data.description;
        document.getElementById("price").value = data.price;
        document.getElementById("category").value = data.category;
        document.getElementById("image").src = data.image;

      } else {
        // doc.data() will be undefined in this case
        console.log("No such document!");
      }
    }).catch(function (error) {
      console.log("Error getting document:", error);
    });
  </script>



  <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</body>

</html>